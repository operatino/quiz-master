var glob = require('glob')
var path = require('path')
var less = require('less')
var fs = require('fs')
var forEach = require('async-foreach').forEach

function lessCli (filePath, cb) {
  var globPattern = path.join(process.cwd(), filePath, '**/*.less')
  glob(globPattern, {}, function (err, files) {
    if (err) { return cb(err) }
    forEach(files, function (file, i) {
      var done = this.async()
      var contents = fs.readFileSync(file, 'utf8')
      less.render(contents, {}, function (err, output) {
        if (err) { return cb(err) }
        var newName = file.replace('.less', '.css')
        fs.writeFileSync(newName, output.css)
        return done(newName)
      })
    }, function (successful, arr) {
      cb(null, arr)
    })
  })
}

module.exports = lessCli
